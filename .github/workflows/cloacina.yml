---
name: Cloacina Tests

on:
  workflow_call:

concurrency:
  group: cloacina-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Feature builds - verify compile-time database backend selection works
  feature-builds:
    name: Feature Build (${{ matrix.features.name }})
    strategy:
      fail-fast: false
      matrix:
        features:
          - name: postgres-only
            flags: --no-default-features --features postgres,macros
            backend: postgres
          - name: sqlite-only
            flags: --no-default-features --features sqlite,macros
            backend: sqlite
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install angreal
        run: |
          python -m pip install --upgrade pip
          pip install angreal

      - name: Remove PostgreSQL libraries (sqlite-only verification)
        if: matrix.features.backend == 'sqlite'
        run: |
          # Remove libpq to verify sqlite-only build doesn't require it
          sudo apt-get remove -y libpq-dev libpq5 || true
          sudo rm -f /usr/lib/x86_64-linux-gnu/libpq* || true

      - name: Install PostgreSQL dev libraries
        if: matrix.features.backend == 'postgres'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Start PostgreSQL services
        if: matrix.features.backend == 'postgres'
        uses: hoverkraft-tech/compose-action@v2.0.1
        with:
          compose-file: ".angreal/docker-compose.yaml"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "cloacina-feature-${{ matrix.features.name }}"

      - name: Build cloacina (${{ matrix.features.name }})
        run: cargo build -p cloacina ${{ matrix.features.flags }}

      - name: Run unit tests (${{ matrix.features.name }})
        run: cargo test -p cloacina --lib ${{ matrix.features.flags }}

      - name: Run integration tests (${{ matrix.features.name }})
        run: angreal cloacina integration --backend ${{ matrix.features.backend }} --features ${{ matrix.features.backend }},macros

  # Unit tests - fast, fail-fast enabled, cross-platform
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install angreal
        run: |
          python -m pip install --upgrade pip
          pip install angreal

      - name: Install PostgreSQL (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install postgresql@14
          echo "$(brew --prefix postgresql@14)/bin" >> $GITHUB_PATH
          echo "PKG_CONFIG_PATH=$(brew --prefix postgresql@14)/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix postgresql@14)/lib" >> $GITHUB_ENV

      - name: Install PostgreSQL dev libraries (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "cloacina -> target"
          shared-key: "cloacina-${{ matrix.os }}"

      - name: Run unit tests (postgres)
        run: angreal cloacina unit --backend postgres

      - name: Run unit tests (sqlite)
        run: angreal cloacina unit --backend sqlite

  # Integration tests - need database services, fail-fast disabled to catch multi-backend issues
  integration-tests:
    name: Integration Tests (${{ matrix.backend }}, ${{ matrix.os }})
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        backend: [postgres, sqlite]
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install angreal
        run: |
          python -m pip install --upgrade pip
          pip install angreal

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "cloacina -> target"
          shared-key: "cloacina-${{ matrix.os }}"

      - name: Start PostgreSQL services (Ubuntu)
        if: matrix.backend == 'postgres' && matrix.os == 'ubuntu-latest' && env.ACT != 'true'
        uses: hoverkraft-tech/compose-action@v2.0.1
        with:
          compose-file: ".angreal/docker-compose.yaml"

      - name: Install debugging tools (Ubuntu)
        if: matrix.backend == 'postgres' && matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb libpq-dev

      - name: Enable core dumps (Ubuntu)
        if: matrix.backend == 'postgres' && matrix.os == 'ubuntu-latest'
        run: |
          ulimit -c unlimited
          # Set core pattern to a predictable location
          sudo sysctl -w kernel.core_pattern=/tmp/core.%e.%p.%t
          # Verify settings
          echo "Core pattern: $(cat /proc/sys/kernel/core_pattern)"
          echo "Core limit: $(ulimit -c)"

      - name: Install PostgreSQL dev libs (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # Always install libpq on macOS - workspace examples need it even for SQLite tests
          brew install postgresql@14
          echo "$(brew --prefix postgresql@14)/bin" >> $GITHUB_PATH
          echo "PKG_CONFIG_PATH=$(brew --prefix postgresql@14)/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix postgresql@14)/lib" >> $GITHUB_ENV

      - name: Start PostgreSQL services (macOS)
        if: matrix.backend == 'postgres' && matrix.os == 'macos-latest'
        run: |
          brew services start postgresql@14
          sleep 5
          # Create the cloacina user and database that tests expect
          createuser -s cloacina || true
          createdb -O cloacina cloacina || true

      - name: Run integration tests (${{ matrix.backend }})
        env:
          RUST_BACKTRACE: full
        run: |
          if [ "${{ matrix.os }}" = "macos-latest" ] && [ "${{ matrix.backend }}" = "postgres" ]; then
            angreal cloacina integration --backend ${{ matrix.backend }} --skip-docker
          elif [ "${{ env.ACT }}" = "true" ] && [ "${{ matrix.backend }}" = "postgres" ]; then
            # Running under act - use host's PostgreSQL, skip docker
            ulimit -c unlimited
            setarch $(uname -m) -R angreal cloacina integration --backend ${{ matrix.backend }} --skip-docker
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ "${{ matrix.backend }}" = "postgres" ]; then
            # Disable ASLR to get consistent crash addresses for debugging
            # Enable core dumps in this shell
            ulimit -c unlimited
            setarch $(uname -m) -R angreal cloacina integration --backend ${{ matrix.backend }}
          else
            angreal cloacina integration --backend ${{ matrix.backend }}
          fi

      - name: Analyze core dump on failure (Ubuntu)
        if: failure() && matrix.backend == 'postgres' && matrix.os == 'ubuntu-latest'
        run: |
          echo "=== Checking for core dumps ==="
          ls -la /tmp/core.* 2>/dev/null || echo "No core dumps found in /tmp"

          # Try to find the test binary
          TEST_BINARY=$(find target/debug/deps -name 'integration-*' -type f -executable 2>/dev/null | head -1)

          if [ -n "$TEST_BINARY" ]; then
            echo "=== Test binary: $TEST_BINARY ==="

            # Analyze any core dumps found
            for core in /tmp/core.*; do
              if [ -f "$core" ]; then
                echo "=== Analyzing core dump: $core ==="
                gdb -batch \
                  -ex "set pagination off" \
                  -ex "bt full" \
                  -ex "info registers" \
                  -ex "info threads" \
                  -ex "thread apply all bt" \
                  "$TEST_BINARY" "$core" 2>&1 | head -300
              fi
            done
          else
            echo "Could not find test binary for gdb analysis"
          fi

      - name: Report compiled workflow sizes
        if: always()
        run: |
          echo "=== Compiled Workflow Library Sizes ==="
          echo "Platform: ${{ matrix.os }}"
          echo "Architecture: $(uname -m)"
          echo ""

          # Function to format size in human-readable format
          format_size() {
            local size=$1
            if [ $size -ge 1048576 ]; then
              echo "$(echo "scale=2; $size / 1048576" | bc) MB"
            elif [ $size -ge 1024 ]; then
              echo "$(echo "scale=2; $size / 1024" | bc) KB"
            else
              echo "$size bytes"
            fi
          }

          echo "| Workflow | Size (bytes) | Size |"
          echo "|----------|--------------|------|"

          # Find and report packaged workflow example
          for ext in dylib so; do
            lib="examples/features/packaged-workflows/target/release/libpackaged_workflow_example.$ext"
            if [ -f "$lib" ]; then
              size=$(stat -f%z "$lib" 2>/dev/null || stat -c%s "$lib" 2>/dev/null)
              echo "| packaged-workflow-example | $size | $(format_size $size) |"
              break
            fi
          done

          # Find and report simple packaged demo
          for ext in dylib so; do
            lib="examples/features/simple-packaged/target/release/libsimple_packaged_demo.$ext"
            if [ -f "$lib" ]; then
              size=$(stat -f%z "$lib" 2>/dev/null || stat -c%s "$lib" 2>/dev/null)
              echo "| simple-packaged-demo | $size | $(format_size $size) |"
              break
            fi
          done

          echo ""
          echo "=== Detailed file info ==="
          find examples/features/*/target/release -name "*.dylib" -o -name "*.so" 2>/dev/null | while read f; do
            if [ -f "$f" ]; then
              ls -lh "$f"
            fi
          done

  # Macro tests - only need to run once per backend (ubuntu only)
  macro-tests:
    name: Macro Tests (${{ matrix.backend }})
    needs: unit-tests
    strategy:
      fail-fast: true
      matrix:
        backend: [postgres, sqlite]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install angreal
        run: |
          python -m pip install --upgrade pip
          pip install angreal

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "cloacina -> target"
          shared-key: "cloacina-ubuntu-latest"

      - name: Install PostgreSQL dev libraries
        if: matrix.backend == 'postgres'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev

      - name: Start PostgreSQL services
        if: matrix.backend == 'postgres'
        uses: hoverkraft-tech/compose-action@v2.0.1
        with:
          compose-file: ".angreal/docker-compose.yaml"

      - name: Run macro tests (${{ matrix.backend }})
        run: angreal cloacina macros --backend ${{ matrix.backend }}
