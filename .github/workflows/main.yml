---
name: CI/CD Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Fail-fast entry point
  smoke_tests:
    uses: ./.github/workflows/smoke_tests.yml

  # Backend-agnostic tests
  docs:
    needs: smoke_tests
    uses: ./.github/workflows/docs.yml
    permissions:
      contents: read
      pages: write
      id-token: write

  # PostgreSQL-specific tests
  postgres_unit_tests:
    needs: smoke_tests
    uses: ./.github/workflows/postgres_unit_tests.yml

  postgres_integration_tests:
    needs: smoke_tests
    uses: ./.github/workflows/postgres_integration_tests.yml

  postgres_macro_tests:
    needs: smoke_tests
    uses: ./.github/workflows/postgres_macro_tests.yml

  # SQLite-specific tests
  sqlite_unit_tests:
    needs: smoke_tests
    uses: ./.github/workflows/sqlite_unit_tests.yml

  sqlite_integration_tests:
    needs: smoke_tests
    uses: ./.github/workflows/sqlite_integration_tests.yml

  sqlite_macro_tests:
    needs: smoke_tests
    uses: ./.github/workflows/sqlite_macro_tests.yml

  # Single backend tests
  tutorials:
    needs: smoke_tests
    uses: ./.github/workflows/tutorials.yml

  examples:
    needs: smoke_tests
    uses: ./.github/workflows/examples.yml

  # Python bindings tests
  python_wheels:
    needs: smoke_tests
    uses: ./.github/workflows/python_wheels.yml

  python_bindings:
    needs: python_wheels
    uses: ./.github/workflows/python_bindings.yml
